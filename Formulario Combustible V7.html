<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Combustible</title>
  <!-- Roboto font for consistent typography -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    /* Global page styles */
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .formulario {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover { background-color: #0056b3; }
    #mensaje_cargando {
      text-align: center;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 15px;
    }

    /* Styles for preview pages to mimic Letter dimensions */
    @page {
      size: letter;
      margin: 1.27cm;
    }
    .page {
      background: white;
      width: 216mm;           /* Carta: 8.5in = 216mm */
      height: 279mm;          /* Carta: 11in = 279mm */
      margin: 20px auto;      /* Separación entre páginas */
      padding: 1.27cm;        /* Márgenes internos de 1.27cm */
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;          /* Contenedor flex para extender contenido */
      flex-direction: column; /* Organizar header y contenido en columna */
      overflow: hidden;       /* Ocultar desbordes */
      page-break-after: always;
    }
    @media print {
      .page { page-break-after: always; margin: 0; box-shadow: none; }
      body { margin: 0; }
    }
    .format-header {
      text-align: center;
      font-weight: bold;
      border: 1px solid #000;
      padding: 5px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .preview-box {
      display: flex;
      gap: 10px; /* Gap between columns */
      flex: 1; /* Fill vertical space under header */
    }
    .invoice-box {
      flex: 0 0 55%; /* Width ratio for invoice box */
      height: 100%;  /* Fill parent height */
    }
    .summary-box {
      flex: 0 0 45%; /* Width ratio for summary box */
      height: 100%;  /* Fill parent height */
    }
    .invoice-box .placeholder {
      width: 100%; height: 100%;
      border: 2px dashed #666;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    .summary-box table {
      width: 100%; height: 100%;
      border-collapse: collapse;
    }
    .summary-box td:first-child { width: 30%; }
    .summary-box td:nth-child(2) { width: 70%; }
    .summary-box td {
      font-size: 14px;
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    /* Adjust page 2 to fill remaining height */
    #photos_table_container {
      flex: 1;               /* Fill vertical space under header */
      display: flex;
      flex-direction: column;
    }
    .photos-table {
      flex: 1;               /* Fill all available height */
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .photos-table td {
      border: 1px solid #ccc;
      padding: 4px;
      vertical-align: top;
      overflow: hidden;
      width: 45%;
      height: 300px; /* Ajustado a 300px según pedido */
    }
    .photos-table td[rowspan="2"] {
      width: 55%;
      height: 530px; /* Ajustado a 530px según pedido */
    }
    .photos-table img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .photo-title { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
    .photo-footer { font-size: 14px; font-weight: bold; text-align: left; padding: 6px; }
    /* Pie de página: altura fija distinta de las fotos */
    .photos-table tr:last-child td {
      height: 20px; /* Ajustado a 20px para el pie de página */ /* Ajusta este valor para cambiar el largo del pie de página */
    }
      /* Ensure preview content matches Letter width */
    html, body { box-sizing: border-box; }
    #preview_contenido {
      width: 216mm;       /* Match page width for PDF capture */
      margin: 0 auto;
      overflow: visible;
    }
  </style>
</head>
<body>
  <!-- Initial loading message displayed while fetching data -->
  <div id="mensaje_cargando">Cargando información, por favor espere...</div>

  <!-- Formulario: oculto hasta cargar sectores y procesos -->
  <div class="formulario" id="formulario_contenido" style="display:none;">
    <h2>Reporte de Gasto de Combustible</h2>
    <!-- Sector selector populated dinámicamente -->
    <label for="sector">Seleccionar Sector:</label>
    <select id="sector"><option value="">Seleccione un sector</option></select>

    <!-- Placa selector dependiente del sector -->
    <label for="placa">Seleccionar Placa del Vehículo:</label>
    <input type="text" id="placa" list="placas" autocomplete="off" placeholder="Escribe o selecciona una placa">
    <datalist id="placas"></datalist>

    <!-- Datos del colaborador -->
    <label for="nombre">Nombre Completo:</label>
    <input type="text" id="nombre" required>

    <label for="identidad">No. Identidad:</label>
    <input type="text" id="identidad" required>

    <!-- Kilometraje y gasto -->
    <label for="total">Total Gastado (L):</label>
    <input type="number" id="total" step="0.01">

    <!-- Motivación del viaje -->
    <label for="motivo">Motivo del Llenado:</label>
    <textarea id="motivo" rows="3"></textarea>

    <!-- Proceso seleccionado por usuario -->
    <label for="proceso">Proceso:</label>
    <select id="proceso"><option value="">Seleccione un proceso</option></select>

    <!-- Fecha y duración -->
    <label for="fecha">Fecha:</label>
    <input type="date" id="fecha">

    <label for="horas">Horas de Viaje:</label>
    <input type="text" id="horas">

    <!-- Datos del vehículo y factura -->
    <label for="km">Km Actual del Vehículo:</label>
    <input type="number" id="km">

    <label for="factura">Número de Factura:</label>
    <input type="text" id="factura">

    <!-- Inputs de imágenes (galería o cámara) -->
    <label for="foto_factura">Fotografía de la Factura:</label>
    <input type="file" id="foto_factura" accept="image/*">

    <label for="foto_tablero_antes">Fotografía Tablero Antes:</label>
    <input type="file" id="foto_tablero_antes" accept="image/*">

    <label for="foto_bomba">Fotografía Bomba:</label>
    <input type="file" id="foto_bomba" accept="image/*">

    <label for="foto_despues">Fotografía Después:</label>
    <input type="file" id="foto_despues" accept="image/*">

    <label for="foto_frontal">Fotografía Frontal del Vehículo:</label>
    <input type="file" id="foto_frontal" accept="image/*">

    <!-- Botón para generar vista previa -->
    <button id="guardar_reporte">Guardar Reporte</button>
  </div>

  <!-- Contenedor de vista previa: dos páginas A4 simuladas -->
  <div id="preview_contenido" style="display:none;">
    <!-- Página 1: resumen e inserción de factura -->
    <div class="page" id="preview_page1">
      <h3 id="format_header" class="format-header"></h3>
      <div class="preview-box">
        <div class="invoice-box">
          <div class="placeholder" id="placeholder_box">Pegar Factura Original en este Espacio</div>
        </div>
        <div class="summary-box" id="summary_box"></div>
      </div>
    </div>
    <!-- Página 2: galería de fotografías con pie de página -->
    <div class="page" id="preview_page2">
      <h3 class="format-header">FOTOGRAFÍAS</h3>
      <div id="photos_table_container"></div>
    </div>
    <!-- Botones para generación de PDF o volver atrás -->
    <button id="enviar_reporte">Enviar Reporte</button>
    <button id="modificar_reporte">Modificar Reporte</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    /* URLs de servicios Google Apps Script */
    const urlVehiculos = "https://script.google.com/macros/s/AKfycbwu3vNXNPeZ7GZlRHlgVw8MvOTe_qOwGPruPxZExAvrKuvd3E1ZYBgqXqCf800KuM5X/exec";
    const urlProcesos  = "https://script.google.com/macros/s/AKfycbzV4X0c77XndhamTSPo9DPrNtQWbjlPEXv7HIIlWWSx48FIXdV-lafOL6FCdzrfqGZf/exec";
    let vehiculos = [], procesos = [];

    /**
     * Carga sectores y placas de la hoja "Vehiculos".
     * Popula <select id="sector"> y muestra el formulario.
     */
    function cargarDatosVehiculos() {
      fetch(urlVehiculos)
        .then(res => res.json())
        .then(data => {
          vehiculos = data;
          const sel = document.getElementById('sector');
          // Eliminar duplicados usando Set
          [...new Set(data.map(x => x.Sector))].forEach(s => sel.add(new Option(s, s)));
          document.getElementById('mensaje_cargando').style.display = 'none';
          document.getElementById('formulario_contenido').style.display = 'block';
        })
        .catch(err => {
          console.error(err);
          document.getElementById('mensaje_cargando').innerText = 'Error al cargar los datos.';
        });
    }

    /**
     * Carga procesos de la hoja "Procesos".
     * Popula <select id="proceso">.
     */
    function cargarProcesos() {
      fetch(urlProcesos)
        .then(res => res.json())
        .then(data => {
          procesos = data.map(item => item.Proceso);
          const sel = document.getElementById('proceso');
          sel.innerHTML = '<option value="">Seleccione un proceso</option>';
          procesos.forEach(p => sel.add(new Option(p, p)));
        })
        .catch(err => console.error('Error al cargar procesos:', err));
    }

    // Al cambiar sector, filtrar placas correspondientes
    document.getElementById('sector').addEventListener('change', function() {
      const dataList = document.getElementById('placas');
      dataList.innerHTML = '';
      vehiculos.filter(v => v.Sector === this.value).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.PLACA;
        dataList.appendChild(opt);
      });
      // Limpiar el input de placa al cambiar el sector
      document.getElementById('placa').value = '';
      // Limpiar proceso
      document.getElementById('proceso').value = '';
    });

    // Guardar reporte y generar vista previa
    document.getElementById('guardar_reporte').onclick = () => {
      // Recopilar datos del formulario
      const data = {
        Fecha:      document.getElementById('fecha').value,
        Nombre:     document.getElementById('nombre').value,
        Identidad:  document.getElementById('identidad').value,
        Total:      document.getElementById('total').value + ' L',
        Motivo:     document.getElementById('motivo').value,
        Proceso:    document.getElementById('proceso').value,
        Horas:      document.getElementById('horas').value,
        Sector:     document.getElementById('sector').value,
        Km:         document.getElementById('km').value,
        FacturaNo:  document.getElementById('factura').value,
        Placa:      document.getElementById('placa').value
      };

      // Formatear encabezado con mes y año
      const meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
      const fDate = new Date(data.Fecha);
      document.getElementById('format_header').textContent =
        `FORMATO DE FACTURAS COMBUSTIBLE ${meses[fDate.getMonth()]} ${fDate.getFullYear()}`;

      // Construir tabla resumen dinámicamente
      const sb = document.getElementById('summary_box'); sb.innerHTML = '';
      const tbl = document.createElement('table');
      const rows = [
        ['Nombre Completo', data.Nombre],
        ['No. Identidad', data.Identidad],
        ['Firma del Colaborador', ''],
        ['Tipo de Gestión', `PLACA: ${data.Placa}`],
        ['Total', data.Total],
        ['Motivo del llenado de combustible',
         `Compra de Combustible al Vehículo<br><br>Para Labores de: ${data.Motivo}<br><br>Proceso: ${data.Proceso}`],
        ['Fecha', data.Fecha],
        ['Horas de Viaje', data.Horas],
        ['Observación',
         `SECTOR: ${data.Sector}<br><br>KM: ${data.Km}<br><br>FACTURA: ${data.FacturaNo}`],
        ['Autorizado por Jefe Inmediato', ''],
        ['Firma', '']
      ];
      rows.forEach(([k,v]) => {
        const r = tbl.insertRow();
        r.insertCell().textContent = k;
        r.insertCell().innerHTML = v;
      });
      sb.appendChild(tbl);

      // Construir galería de fotografías
      const container = document.getElementById('photos_table_container');
      const imgHTML = id => {
        const f = document.getElementById(id).files[0];
        if (!f) return '';
        return `<img src="${URL.createObjectURL(f)}" class="photo-img">`;
      };
      container.innerHTML = `
        <table class="photos-table">
          <tr>
            <td><div class="photo-title">TABLERO ANTES DE LLENADO</div>${imgHTML('foto_tablero_antes')}</td>
            <td colspan="2"><div class="photo-title">BOMBA DE COMBUSTIBLE</div>${imgHTML('foto_bomba')}</td>
          </tr>
          <tr>
            <td><div class="photo-title">TABLERO DESPUÉS DE LLENADO</div>${imgHTML('foto_despues')}</td>
            <td colspan="2" rowspan="2"><div class="photo-title">FACTURA</div>${imgHTML('foto_factura')}</td>
          </tr>
          <tr>
            <td><div class="photo-title">VISTA FRONTAL DEL VEHÍCULO</div>${imgHTML('foto_frontal')}</td>
          </tr>
          <tr>
            <td class="photo-footer">PLACA: ${data.Placa}</td>
            <td class="photo-footer">FECHA: ${data.Fecha}</td>
            <td class="photo-footer">FACTURA: ${data.FacturaNo}</td>
          </tr>
        </table>`;

      // Mostrar vista previa y ocultar formulario
      document.getElementById('formulario_contenido').style.display = 'none';
      document.getElementById('preview_contenido').style.display = 'block';
    };

    // Volver al formulario desde la vista previa
    document.getElementById('modificar_reporte').onclick = () => {
      document.getElementById('preview_contenido').style.display = 'none';
      document.getElementById('formulario_contenido').style.display = 'block';
    };

    // Generar y descargar PDF de forma manual para controlar cada página
    document.getElementById('enviar_reporte').onclick = () => {
      const btnEnviar = document.getElementById('enviar_reporte');
      const btnMod = document.getElementById('modificar_reporte');
      btnEnviar.style.display = 'none';
      btnMod.style.display = 'none';

      const pages = document.querySelectorAll('.page');
      const margins = {top: 12.7, left: 12.7, bottom: 12.7, right: 12.7}; // mm
      const pdf = new jspdf.jsPDF({unit: 'mm', format: 'letter', orientation: 'portrait'});

      pages.forEach((pg, index) => {
        // Quitar sombra antes de capturar la página
        pg.style.boxShadow = 'none';
        html2canvas(pg, { scale: 1, useCORS: true, backgroundColor: '#ffffff' }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const pdfWidth = pdf.internal.pageSize.getWidth() - margins.left - margins.right;
          const pdfHeight = pdf.internal.pageSize.getHeight() - margins.top - margins.bottom;
          if (index > 0) pdf.addPage();
          pdf.addImage(imgData, 'PNG', margins.left, margins.top, pdfWidth, pdfHeight);
          if (index === pages.length - 1) {
            pdf.save(`reporte_${Date.now()}.pdf`);
            btnEnviar.style.display = 'inline-block';
            btnMod.style.display = 'inline-block';
          }
        });
      });
    };


    // Inicializar carga al abrir página
    window.onload = () => {
      cargarDatosVehiculos();
      cargarProcesos();
    };
  </script>

  <!-- Incluir html2pdf.js desde CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</body>
</html>

  <!-- Incluir html2pdf.js desde CDN para generación de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</body>
</html>
